# 热更新机制

## 概述

ET框架提供完整的热更新解决方案，支持代码、资源和配置三位一体的热更新。热更新机制允许在不重新发布应用的情况下更新游戏内容，大大提升了迭代效率和用户体验。

## 热更新类型

### 1. 代码热更新
- **技术**: HybridCLR
- **内容**: C#代码和逻辑
- **特点**: 
  - 支持完整C#语法
  - 运行时动态加载
  - 无缝切换

### 2. 资源热更新
- **技术**: YooAsset
- **内容**: Unity资源（Prefab、Texture、Audio等）
- **特点**:
  - 增量更新
  - 版本管理
  - 断点续传

### 3. 配置热更新
- **技术**: Luban配置系统
- **内容**: Excel配置和游戏数据
- **特点**:
  - 实时更新
  - 支持多种格式
  - 类型安全

## 代码热更新 (HybridCLR)

### 原理

HybridCLR通过在Unity中集成完整的.NET运行时，实现C#代码的运行时解释执行。

### 配置

#### AOT DLL配置
```xml
<!-- YooAsset/AotDlls配置 -->
<AotDlls>
    <AotDll name="mscorlib.dll" />
    <AotDll name="System.dll" />
    <AotDll name="System.Core.dll" />
    <!-- 其他AOT DLL -->
</AotDlls>
```

### 热更新代码结构

```
Unity/Assets/Scripts/
├── Hotfix/              # 可热更新代码
│   ├── Share/          # 共享热更新代码
│   ├── Client/         # 客户端热更新代码
│   └── Server/         # 服务端热更新代码
├── HotfixView/         # UI热更新代码
│   └── Client/         # 客户端UI热更新代码
├── Model/              # 不可热更新模型
└── ModelView/          # 不可热更新UI模型
```

### 编译流程

#### 1. 生成HybridCLR文件
```powershell
# Unity菜单: HybridCLR -> Generate -> All
```

#### 2. 复制AOT DLL
```powershell
# Unity菜单: ET -> HybridCLR -> CopyAotDlls
```

#### 3. 热重载
```powershell
# Unity菜单: ET -> Reload 或按F7
```

### 使用示例

```csharp
// Hotfix中的代码可以随时更新
namespace ET.Client
{
    [EntitySystemOf(typeof(PlayerComponent))]
    public static partial class PlayerComponentSystem
    {
        [EntitySystem]
        private static void Awake(this PlayerComponent self)
        {
            // 这段代码可以热更新
            Log.Debug("Player initialized");
        }
        
        public static void DoSomething(this PlayerComponent self)
        {
            // 业务逻辑可以热更新
        }
    }
}
```

## 资源热更新 (YooAsset)

### 原理

YooAsset基于AssetBundle实现资源的增量更新，支持版本管理和断点续传。

### 配置

#### YooAsset设置
```csharp
// 初始化YooAsset
var package = YooAssets.GetPackage("DefaultPackage");
package.InitializeAsync(new InitializationParameters
{
    BuildinQueryMode = EQueryMode.UseDatabase,
    RemoteServices = new RemoteServices()
});
```

### 资源打包

#### 1. 配置构建参数
```
YooAsset -> AssetBundle Builder
- Build Output: Bundles
- Build Mode: Force Rebuild
- Encryption: Enable
```

#### 2. 执行构建
```powershell
# 通过Unity菜单操作
# YooAsset -> AssetBundle Builder -> Build
```

### 资源更新流程

```csharp
// 1. 检查版本更新
var packageVersion = await package.UpdatePackageVersionAsync();

// 2. 更新资源包
var operation = package.UpdatePackageManifestAsync(packageVersion);
await operation;

// 3. 下载资源
var downloader = package.CreateResourceDownloader(operation.UpdatePackageManifest, 3, 3);
await downloader.BeginDownloadAsync();

// 4. 清理旧资源
await package.ClearUnusedCacheFilesAsync();
```

### 资源加载

```csharp
// 加载单个资源
var handle = package.LoadAssetAsync<GameObject>("Assets/Prefabs/Player.prefab");
await handle;
GameObject player = handle.InstantiateAsync();

// 加载场景
var sceneHandle = package.LoadSceneAsync("Assets/Scenes/Main.unity");
await sceneHandle;
```

## 配置热更新 (Luban)

### 原理

Luban将Excel配置编译为二进制文件，支持运行时动态加载和更新。

### Excel配置结构

```
Config/Excel/
├── Datas/
│   ├── AIConfig.xlsx        # AI配置
│   ├── BuffConfig.xlsx      # Buff配置
│   └── __beans__.xlsx       # 配置定义
└── Defines/
    └── __root__.xml         # 根配置
```

### 配置导出

#### 1. 导出客户端配置
```powershell
cd Tools/Luban
./gen_code_client.sh
```

#### 2. 导出服务端配置
```powershell
cd Tools/Luban
./gen_code_server.sh
```

#### 3. 导出客户端和服务端配置
```powershell
cd Tools/Luban
./gen_code_client_server.sh
```

### 配置使用

```csharp
// 获取配置类别
var configCategory = ConfigCategory.Instance.Get<AIConfigCategory>();

// 获取配置项
AIConfig config = configCategory.Get(configId);

// 使用配置
int attackSpeed = config.AttackSpeed;
float moveSpeed = config.MoveSpeed;
```

### 配置更新

```csharp
// 重新加载配置
await ConfigComponent.Instance.LoadConfigAsync();

// 配置会自动更新，无需重启
```

## 热更新最佳实践

### 1. 代码分层
- 将经常变更的逻辑放在Hotfix层
- 将稳定的核心放在Model层
- UI逻辑放在HotfixView层

### 2. 资源管理
- 使用Addressable管理大资源
- 合理设置资源分组
- 定期清理未使用资源

### 3. 配置设计
- 使用Excel管理游戏数据
- 配置项应该完整和类型安全
- 支持多语言和多环境

### 4. 版本控制
- 维护清晰的版本号
- 记录每次更新的内容
- 提供回滚机制

### 5. 错误处理
- 检测更新失败情况
- 提供重试机制
- 记录详细日志

## 常见问题

### Q: 热更新失败怎么办?
A: 
1. 检查网络连接
2. 查看更新日志
3. 尝试重新下载
4. 联系技术支持

### Q: 如何回滚版本?
A: 
1. 清理缓存
2. 下载旧版本资源
3. 重新加载配置

### Q: 热更新会影响性能吗?
A: 
- 初始加载会有轻微延迟
- 运行性能基本无影响
- 建议在后台更新

## 相关文档

- [ECS架构](ECS架构.md)
- [Fiber模块](Fiber模块.md)
- [网络通信模块](网络通信模块.md)
- [工具模块](工具模块.md)
