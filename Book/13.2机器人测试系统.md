# 机器人测试系统

## 概述

ET框架提供完整的机器人测试系统，支持自动化测试、压力测试、功能测试等多种测试场景。机器人测试系统可以模拟真实玩家行为，快速验证游戏功能。

## 测试系统架构

### 测试组件

```
RobotTest
├── RobotComponent         # 机器人组件
├── RobotCaseDispatcher   # 测试用例调度器
├── RobotCaseHandler      # 测试用例处理器
└── RobotConsole          # 机器人控制台
```

## 机器人启动

### 启动命令

```powershell
# 启动测试进程
pwsh -Command "dotnet ./Bin/ET.App.dll --Process=1 --SceneName=RobotTest --StartConfig=Localhost --Console=1 --SingleThread=1"
```

### 测试命令

```bash
# 测试所有用例
Case --Id=0

# 测试指定用例
Case --Id=1

# 连续执行多个用例
Case --Id=1
Case --Id=2
```

### 命令行执行

```bash
# 单个测试用例
printf "Case --Id=0\n" | pwsh -Command "dotnet ./Bin/ET.App.dll --Process=1 --SceneName=RobotTest --StartConfig=Localhost --Console=1 --SingleThread=1"

# 多个测试用例（推荐）
printf "Case --Id=1\nCase --Id=2\n" | pwsh -Command "dotnet ./Bin/ET.App.dll --Process=1 --SceneName=RobotTest --StartConfig=Localhost --Console=1 --SingleThread=1"
```

## 测试用例编写

### 测试用例基类

```csharp
// 机器人测试用例基类
public abstract class ARobotCaseHandler
{
    // 测试用例ID
    public abstract int Id { get; }
    
    // 测试用例名称
    public abstract string Name { get; }
    
    // 运行测试用例
    public abstract async ETTask Run(Fiber fiber, RobotCase robotCase);
}
```

### 测试用例示例

```csharp
// 创建机器人测试用例
[RobotCase(RobotCaseType.CreateRobot)]
public class RobotCase_001_CreateRobot_Handler : ARobotCaseHandler
{
    public override int Id => (int)RobotCaseType.CreateRobot;
    
    public override string Name => "创建机器人";
    
    protected override async ETTask Run(Fiber fiber, RobotCase robotCase)
    {
        // 1. 创建机器人
        Robot robot = await CreateRobot(fiber);
        
        // 2. 验证机器人创建成功
        if (robot == null)
        {
            throw new Exception("Robot create failed");
        }
        
        // 3. 验证机器人ID
        if (robot.Id <= 0)
        {
            throw new Exception("Robot ID is invalid");
        }
        
        Log.Console("Robot created successfully");
    }
}
```

### 测试用例类型

```csharp
// 机器人测试用例类型
public enum RobotCaseType
{
    None = 0,
    CreateRobot = 1,           # 创建机器人
    Login = 2,                 # 登录测试
    EnterMap = 3,              # 进入地图
    Move = 4,                   # 移动测试
    Attack = 5,                 # 攻击测试
    Battle = 6,                 # 战斗测试
    Chat = 7,                   # 聊天测试
    Match = 8,                  # 匹配测试
}
```

## 测试用例调度器

### RobotCaseDispatcher

```csharp
// 机器人测试用例调度器
public static partial class RobotCaseDispatcher
{
    // 测试用例字典
    private static readonly Dictionary<int, ARobotCaseHandler> handlers = new();
    
    // 注册测试用例
    public static void Register(ARobotCaseHandler handler)
    {
        handlers.Add(handler.Id, handler);
    }
    
    // 获取测试用例
    public static ARobotCaseHandler GetHandler(int caseId)
    {
        return handlers.TryGetValue(caseId, out var handler) ? handler : null;
    }
    
    // 运行测试用例
    public static async ETTask RunCase(Fiber fiber, int caseId)
    {
        ARobotCaseHandler handler = GetHandler(caseId);
        if (handler == null)
        {
            Log.Error($"Robot case handler not found: {caseId}");
            return;
        }
        
        try
        {
            await handler.Run(fiber, null);
            Log.Console($"case run success: {caseId}");
        }
        catch (Exception e)
        {
            Log.Error($"case run failed: {caseId}, error: {e}");
        }
    }
}
```

## 测试数据准备

### 配置准备

```csharp
// 准备配置数据
private static QuestConfigCategory PrepareConfig()
{
    // 在代码中写JSON配置
    string json = @"
    {
        ""Quests"": {
            ""1"": {
                ""Id"": 1,
                ""Name"": ""Test Quest"",
                ""Description"": ""Test Quest Description"",
                ""Rewards"": [
                    {
                        ""ItemId"": 1001,
                        ""Count"": 10
                    }
                ]
            }
        }
    }";
    
    // 反序列化配置
    QuestConfigCategory config = MongoHelper.FromJson<QuestConfigCategory>(json);
    return config;
}
```

### 数据准备

```csharp
// 准备测试数据
private static async ETTask PrepareTestData(Fiber fiber)
{
    // 1. 获取服务端Fiber
    string mapName = robot.Root.CurrentScene().Name;
    Fiber map = fiber.GetFiber("MapManager").GetFiber(mapName);
    
    // 2. 获取Unit的Id
    Client.PlayerComponent playerComponent = robot.Root.GetComponent<Client.PlayerComponent>();
    
    // 3. 获取服务端Unit
    Unit serverUnit = map.Root.GetComponent<UnitComponent>().Get(playerComponent.MyId);
    
    // 4. 设置测试数据
    serverUnit.GetComponent<NumericComponent>().Set(NumericType.Hp, 1000);
    serverUnit.GetComponent<NumericComponent>().Set(NumericType.MaxHp, 1000);
}
```

## 测试环境

### 环境准备

```csharp
// 测试环境初始化
[Event(SceneType.RobotTest)]
public class RobotTestEvent : AEvent<Scene, EventType.RobotTestInit>
{
    protected override async ETTask Run(Scene scene, EventType.RobotTestInit args)
    {
        // 1. 初始化服务器环境
        await InitServerEnvironment(scene);
        
        // 2. 创建测试账号
        await CreateTestAccounts(scene);
        
        // 3. 准备测试数据
        await PrepareTestData(scene);
    }
}
```

### 环境清理

```csharp
// 测试环境清理
private static async ETTask CleanupEnvironment(Fiber fiber)
{
    // 1. 清理机器人
    Robot robot = fiber.Root.GetComponent<Robot>();
    robot?.Dispose();
    
    // 2. 清理测试数据
    await CleanupTestData(fiber);
    
    // 3. 关闭连接
    NetComponent net = fiber.Root.GetComponent<NetComponent>();
    net?.Dispose();
}
```

## 测试结果验证

### 结果检查

```csharp
// 验证测试结果
private static void VerifyResult(Robot robot)
{
    // 1. 检查机器人状态
    if (robot.IsDisposed)
    {
        throw new Exception("Robot is disposed");
    }
    
    // 2. 检查登录状态
    Client.PlayerComponent player = robot.Root.GetComponent<Client.PlayerComponent>();
    if (player == null)
    {
        throw new Exception("Player component not found");
    }
    
    // 3. 检查地图状态
    Scene currentScene = robot.Root.CurrentScene();
    if (currentScene == null)
    {
        throw new Exception("Current scene is null");
    }
}
```

### 异常处理

```csharp
// 异常处理
protected override async ETTask Run(Fiber fiber, RobotCase robotCase)
{
    try
    {
        // 执行测试逻辑
        await ExecuteTest(fiber);
        
        // 验证结果
        VerifyResult(fiber);
    }
    catch (Exception e)
    {
        Log.Error($"Test case failed: {e}");
        
        // 清理环境
        await CleanupEnvironment(fiber);
        
        // 重新抛出异常
        throw;
    }
}
```

## 测试日志

### 日志管理

```csharp
// 日志目录
const string LogDir = "Logs";

// 测试前删除日志
private static void CleanupLogs()
{
    if (Directory.Exists(LogDir))
    {
        Directory.Delete(LogDir, true);
    }
}

// 查看日志
private static void ViewLogs()
{
    string allLogPath = Path.Combine(LogDir, "All.log");
    if (File.Exists(allLogPath))
    {
        string logs = File.ReadAllText(allLogPath);
        Log.Console(logs);
    }
}
```

### 日志输出

```csharp
// 输出测试日志
Log.Debug("Test started");
Log.Error("Test failed: {error}", error);
Log.Console("Test result: {result}", result);
```

## 压力测试

### 压力测试配置

```csharp
// 压力测试配置
public class StressTestConfig
{
    public int RobotCount { get; set; } = 100;      # 机器人数量
    public int TestCaseId { get; set; } = 1;        # 测试用例ID
    public int Duration { get; set; } = 60;         # 测试时长（秒）
    public int ConcurrentCount { get; set; } = 10;   # 并发数量
}
```

### 压力测试执行

```csharp
// 执行压力测试
public static async ETTask RunStressTest(StressTestConfig config)
{
    // 1. 创建机器人池
    List<Robot> robots = new List<Robot>();
    for (int i = 0; i < config.RobotCount; i++)
    {
        Robot robot = await CreateRobot();
        robots.Add(robot);
    }
    
    // 2. 并发执行测试
    List<ETTask> tasks = new List<ETTask>();
    foreach (Robot robot in robots)
    {
        tasks.Add(RunTestCase(robot, config.TestCaseId));
    }
    
    // 3. 等待测试完成
    await ETTask.WhenAll(tasks);
    
    // 4. 统计测试结果
    StressTestResult result = CalculateResult(robots);
    Log.Console($"Stress test completed: {result}");
}
```

## 最佳实践

### 1. 测试用例设计
- 单一职责
- 独立运行
- 快速执行
- 可重复

### 2. 测试数据管理
- 使用配置
- 动态生成
- 及时清理
- 版本控制

### 3. 测试环境
- 隔离环境
- 一致性
- 可恢复
- 可调试

### 4. 测试结果
- 详细记录
- 自动验证
- 统计分析
- 报告生成

## 常见问题

### Q: 如何调试测试用例?
A: 
1. 查看日志文件
2. 使用断点调试
3. 添加详细日志
4. 分步执行

### Q: 测试用例失败怎么办?
A: 
1. 查看错误日志
2. 检查环境配置
3. 验证测试数据
4. 修复问题后重试

### Q: 如何优化测试性能?
A: 
1. 减少测试用例数量
2. 优化测试逻辑
3. 并行执行测试
4. 使用测试数据缓存

## 相关文档

- [ECS架构](ECS架构.md)
- [Fiber模块](Fiber模块.md)
- [网络通信模块](网络通信模块.md)
- [服务端模块](服务端模块.md)
