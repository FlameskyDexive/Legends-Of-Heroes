# 日志系统

## 概述

ET框架提供完整的日志系统，支持多级别日志、日志过滤、日志输出到文件等功能。日志系统是项目调试和问题定位的重要工具。

## 日志架构

### 日志组件

```
Log
├── Log                    # 日志主类
├── ILog                   # 日志接口
├── Logger                 # 日志器
├── NLogger                # NLog日志器
└── UnityLogger            # Unity日志器
```

## 日志接口

### ILog

```csharp
// 日志接口
public interface ILog
{
    // 调试日志
    void Debug(string message);
    void Debug(string message, params object[] args);
    
    // 信息日志
    void Info(string message);
    void Info(string message, params object[] args);
    
    // 警告日志
    void Warning(string message);
    void Warning(string message, params object[] args);
    
    // 错误日志
    void Error(string message);
    void Error(string message, params object[] args);
    
    // 异常日志
    void Exception(Exception e);
}
```

## Log类

### Log

```csharp
// 日志主类
public static class Log
{
    // 日志器
    private static ILog logger;
    
    // 初始化日志
    public static void Init(ILog log)
    {
        logger = log;
    }
    
    // 调试日志
    public static void Debug(string message)
    {
        logger?.Debug(message);
    }
    
    public static void Debug(string message, params object[] args)
    {
        logger?.Debug(string.Format(message, args));
    }
    
    // 信息日志
    public static void Info(string message)
    {
        logger?.Info(message);
    }
    
    public static void Info(string message, params object[] args)
    {
        logger?.Info(string.Format(message, args));
    }
    
    // 警告日志
    public static void Warning(string message)
    {
        logger?.Warning(message);
    }
    
    public static void Warning(string message, params object[] args)
    {
        logger?.Warning(string.Format(message, args));
    }
    
    // 错误日志
    public static void Error(string message)
    {
        logger?.Error(message);
    }
    
    public static void Error(string message, params object[] args)
    {
        logger?.Error(string.Format(message, args));
    }
    
    // 异常日志
    public static void Exception(Exception e)
    {
        logger?.Exception(e);
    }
    
    // 控制台日志
    public static void Console(string message)
    {
        logger?.Info(message);
    }
    
    public static void Console(string message, params object[] args)
    {
        logger?.Info(string.Format(message, args));
    }
}
```

## Logger

### Logger

```csharp
// 日志器
public class Logger : ILog
{
    // 日志级别
    public enum LogLevel
    {
        Debug,
        Info,
        Warning,
        Error
    }
    
    // 当前日志级别
    public LogLevel CurrentLevel { get; set; } = LogLevel.Debug;
    
    // 调试日志
    public void Debug(string message)
    {
        if (CurrentLevel <= LogLevel.Debug)
        {
            WriteLog(LogLevel.Debug, message);
        }
    }
    
    public void Debug(string message, params object[] args)
    {
        Debug(string.Format(message, args));
    }
    
    // 信息日志
    public void Info(string message)
    {
        if (CurrentLevel <= LogLevel.Info)
        {
            WriteLog(LogLevel.Info, message);
        }
    }
    
    public void Info(string message, params object[] args)
    {
        Info(string.Format(message, args));
    }
    
    // 警告日志
    public void Warning(string message)
    {
        if (CurrentLevel <= LogLevel.Warning)
        {
            WriteLog(LogLevel.Warning, message);
        }
    }
    
    public void Warning(string message, params object[] args)
    {
        Warning(string.Format(message, args));
    }
    
    // 错误日志
    public void Error(string message)
    {
        if (CurrentLevel <= LogLevel.Error)
        {
            WriteLog(LogLevel.Error, message);
        }
    }
    
    public void Error(string message, params object[] args)
    {
        Error(string.Format(message, args));
    }
    
    // 异常日志
    public void Exception(Exception e)
    {
        Error($"Exception: {e.Message}\n{e.StackTrace}");
    }
    
    // 写入日志
    private void WriteLog(LogLevel level, string message)
    {
        string logMessage = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] [{level}] {message}";
        Console.WriteLine(logMessage);
    }
}
```

## NLogger

### NLogger

```csharp
// NLog日志器
public class NLogger : ILog
{
    private readonly NLog.Logger logger;
    
    public NLogger(string name)
    {
        logger = NLog.LogManager.GetLogger(name);
    }
    
    // 调试日志
    public void Debug(string message)
    {
        logger.Debug(message);
    }
    
    public void Debug(string message, params object[] args)
    {
        logger.Debug(message, args);
    }
    
    // 信息日志
    public void Info(string message)
    {
        logger.Info(message);
    }
    
    public void Info(string message, params object[] args)
    {
        logger.Info(message, args);
    }
    
    // 警告日志
    public void Warning(string message)
    {
        logger.Warn(message);
    }
    
    public void Warning(string message, params object[] args)
    {
        logger.Warn(message, args);
    }
    
    // 错误日志
    public void Error(string message)
    {
        logger.Error(message);
    }
    
    public void Error(string message, params object[] args)
    {
        logger.Error(message, args);
    }
    
    // 异常日志
    public void Exception(Exception e)
    {
        logger.Error(e, "Exception occurred");
    }
}
```

## UnityLogger

### UnityLogger

```csharp
// Unity日志器
public class UnityLogger : ILog
{
    // 调试日志
    public void Debug(string message)
    {
        UnityEngine.Debug.Log(message);
    }
    
    public void Debug(string message, params object[] args)
    {
        UnityEngine.Debug.LogFormat(message, args);
    }
    
    // 信息日志
    public void Info(string message)
    {
        UnityEngine.Debug.Log($"[Info] {message}");
    }
    
    public void Info(string message, params object[] args)
    {
        UnityEngine.Debug.LogFormat($"[Info] {message}", args);
    }
    
    // 警告日志
    public void Warning(string message)
    {
        UnityEngine.Debug.LogWarning(message);
    }
    
    public void Warning(string message, params object[] args)
    {
        UnityEngine.Debug.LogWarningFormat(message, args);
    }
    
    // 错误日志
    public void Error(string message)
    {
        UnityEngine.Debug.LogError(message);
    }
    
    public void Error(string message, params object[] args)
    {
        UnityEngine.Debug.LogErrorFormat(message, args);
    }
    
    // 异常日志
    public void Exception(Exception e)
    {
        UnityEngine.Debug.LogException(e);
    }
}
```

## 日志配置

### NLog配置

```xml
<!-- NLog.config -->
<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwExceptions="false">
    
    <!-- 日志目标 -->
    <targets>
        <!-- 控制台输出 -->
        <target name="console" xsi:type="ColoredConsole"
                layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=ToString}"/>
        
        <!-- 文件输出 -->
        <target name="file" xsi:type="File"
                fileName="${basedir}/Logs/${shortdate}.log"
                layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=ToString}"
                archiveFileName="${basedir}/Logs/Archives/${shortdate}.{#}.log"
                archiveEvery="Day"
                archiveNumbering="Rolling"
                maxArchiveFiles="30"/>
    </targets>
    
    <!-- 日志规则 -->
    <rules>
        <logger name="*" minlevel="Debug" writeTo="console,file"/>
    </rules>
</nlog>
```

### 日志级别配置

```csharp
// 配置日志级别
public static class LogConfig
{
    // 开发环境：所有日志
    public static void SetDevelopmentMode()
    {
        Log.Init(new Logger { CurrentLevel = Logger.LogLevel.Debug });
    }
    
    // 生产环境：只记录错误
    public static void SetProductionMode()
    {
        Log.Init(new Logger { CurrentLevel = Logger.LogLevel.Error });
    }
    
    // 测试环境：记录信息和错误
    public static void SetTestMode()
    {
        Log.Init(new Logger { CurrentLevel = Logger.LogLevel.Info });
    }
}
```

## 日志使用规范

### 日志级别使用

```csharp
// Debug：调试信息，开发阶段使用
Log.Debug("Player position: {x}, {y}, {z}", position.x, position.y, position.z);

// Info：重要信息，记录关键流程
Log.Info("Player {playerId} logged in", playerId);

// Warning：警告信息，不影响功能但需要注意
Log.Warning("Player {playerId} has low health: {hp}", playerId, hp);

// Error：错误信息，需要修复
Log.Error("Failed to load player data: {error}", error);

// Exception：异常信息，记录异常堆栈
try
{
    // 代码逻辑
}
catch (Exception e)
{
    Log.Exception(e);
}
```

### 日志最佳实践

```csharp
// 1. 使用格式化字符串
Log.Debug("Player {0} moved to {1}", playerId, position);

// 2. 记录关键操作
Log.Info("Quest {questId} started by player {playerId}", questId, playerId);

// 3. 记录错误上下文
Log.Error("Failed to save player {playerId}. Error: {error}", playerId, error);

// 4. 记录性能数据
Log.Info("Load time: {0}ms", loadTime);

// 5. 记录异常堆栈
try
{
    await LoadData();
}
catch (Exception e)
{
    Log.Error("Load data failed: {0}", e.Message);
    Log.Exception(e);
}
```

## 日志文件管理

### 日志目录

```
Logs/
├── All.log              # 所有日志
├── Debug.log            # 调试日志
├── Info.log             # 信息日志
├── Warning.log          # 警告日志
├── Error.log            # 错误日志
└── Archives/            # 归档日志
    ├── 2026-01-20.1.log
    ├── 2026-01-20.2.log
    └── 2026-01-21.1.log
```

### 日志清理

```csharp
// 日志清理器
public static class LogCleaner
{
    // 清理旧日志
    public static void CleanOldLogs(int keepDays = 7)
    {
        string logDir = "Logs";
        if (!Directory.Exists(logDir))
        {
            return;
        }
        
        DateTime cutoffDate = DateTime.Now.AddDays(-keepDays);
        
        // 清理归档日志
        string archiveDir = Path.Combine(logDir, "Archives");
        if (Directory.Exists(archiveDir))
        {
            foreach (string file in Directory.GetFiles(archiveDir, "*.log"))
            {
                FileInfo fileInfo = new FileInfo(file);
                if (fileInfo.CreationTime < cutoffDate)
                {
                    File.Delete(file);
                }
            }
        }
        
        // 清理旧日志文件
        foreach (string file in Directory.GetFiles(logDir, "*.log"))
        {
            FileInfo fileInfo = new FileInfo(file);
            if (fileInfo.CreationTime < cutoffDate)
            {
                File.Delete(file);
            }
        }
    }
}
```

## 日志分析

### 日志查看器

```csharp
// 日志查看器
public class LogViewer
{
    // 读取日志文件
    public static List<LogEntry> ReadLogFile(string filePath)
    {
        List<LogEntry> entries = new List<LogEntry>();
        string[] lines = File.ReadAllLines(filePath);
        
        foreach (string line in lines)
        {
            LogEntry entry = ParseLogEntry(line);
            if (entry != null)
            {
                entries.Add(entry);
            }
        }
        
        return entries;
    }
    
    // 解析日志条目
    private static LogEntry ParseLogEntry(string line)
    {
        // 格式: [2026-01-20 10:30:00] [DEBUG] Message
        string pattern = @"\[(.*?)\] \[(.*?)\] (.*)";
        Match match = Regex.Match(line, pattern);
        
        if (match.Success)
        {
            return new LogEntry
            {
                Time = DateTime.Parse(match.Groups[1].Value),
                Level = match.Groups[2].Value,
                Message = match.Groups[3].Value
            };
        }
        
        return null;
    }
}

// 日志条目
public class LogEntry
{
    public DateTime Time { get; set; }
    public string Level { get; set; }
    public string Message { get; set; }
}
```

## 最佳实践

### 1. 日志设计
- 合理使用日志级别
- 记录关键信息
- 包含上下文信息
- 避免过度日志

### 2. 性能优化
- 延迟日志写入
- 异步日志
- 日志缓冲
- 条件日志

### 3. 日志管理
- 定期清理
- 日志归档
- 日志分析
- 错误统计

### 4. 调试工具
- 日志查看器
- 日志过滤
- 日志搜索
- 日志统计

## 常见问题

### Q: 如何减少日志文件大小?
A: 
1. 调整日志级别
2. 清理旧日志
3. 压缩日志文件
4. 分级日志

### Q: 如何调试生产环境问题?
A: 
1. 查看错误日志
2. 分析日志上下文
3. 增加调试日志
4. 重现问题

### Q: 如何优化日志性能?
A: 
1. 异步日志
2. 日志缓冲
3. 条件日志
4. 延迟写入

## 相关文档

- [项目概述](项目概述.md)
- [ECS架构](ECS架构.md)
- [Fiber模块](Fiber模块.md)
- [服务端模块](服务端模块.md)
