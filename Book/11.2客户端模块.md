# 客户端模块

## 概述

ET框架客户端基于Unity引擎，提供完整的游戏客户端解决方案，包括UI系统、资源管理、输入系统、场景管理等核心功能。

## 客户端架构

### 程序集分层

```
Unity.HotfixView (UI热更新层)
    ↓
Unity.Hotfix (逻辑热更新层)
    ↓
Unity.ModelView (UI模型层)
    ↓
Unity.Model (游戏逻辑模型层)
    ↓
Unity.Loader (加载器和启动层)
    ↓
Unity.Core (框架核心层)
```

### 目录结构

```
Unity/Assets/Scripts/
├── Core/              # 核心框架
├── Hotfix/            # 热更新代码
│   └── Client/       # 客户端热更新逻辑
├── HotfixView/        # UI热更新代码
│   └── Client/       # 客户端UI热更新逻辑
├── Model/             # 模型层
│   └── Client/       # 客户端模型
├── ModelView/         # UI模型层
│   └── Client/       # 客户端UI模型
└── Loader/            # 加载器
```

## UI系统

### UI架构

ET框架使用EUI（Easy UI）系统，基于Entity-Component-UI设计模式。

### UI组件

```csharp
// UI实体
public class UI : Entity, IAwake
{
    // UI名称
    public string Name;
    
    // UI窗口
    public Window Window;
    
    // UI层级
    public int Layer;
}

// Window基类
public class Window : Entity, IAwake
{
    // UI GameObject
    public GameObject GameObject;
    
    // UI组件
    public Dictionary<string, UIComponent> Components = new();
    
    // 打开UI
    public async ETTask Open();
    
    // 关闭UI
    public void Close();
}
```

### UI管理

```csharp
// UI管理器
public class UIManager : Singleton<UIManager>
{
    // UI字典
    private Dictionary<string, UI> uis = new();
    
    // 打开UI
    public async ETTask<UI> Open(string name);
    
    // 关闭UI
    public void Close(string name);
    
    // 获取UI
    public UI Get(string name);
}
```

### UI层级

```csharp
// UI层级定义
public enum UILayer
{
    Bottom,      # 底层
    Main,        # 主层
    Top,         # 顶层
    Popup,       # 弹出层
    Tip          # 提示层
}
```

### UI示例

```csharp
// 登录UI
[EntitySystemOf(typeof(DlgLogin))]
public static partial class DlgLoginSystem
{
    [EntitySystem]
    private static void Awake(this DlgLogin self)
    {
        // 初始化UI
        self.LoginButton.onClick.AddListener(() => self.OnLoginClick());
    }
    
    public static async ETTask OnLoginClick(this DlgLogin self)
    {
        // 获取输入
        string account = self.AccountInput.text;
        string password = self.PasswordInput.text;
        
        // 发送登录请求
        C2R_Login loginRequest = C2R_Login.Create();
        loginRequest.Account = account;
        loginRequest.Password = password;
        
        var response = await session.Call<R2C_Login>(loginRequest);
        
        // 处理响应
        if (response.Error == ErrorCode.ERR_Success)
        {
            // 登录成功，进入游戏
            await EnterGame();
        }
    }
}
```

## 资源管理

### YooAsset集成

```csharp
// 资源组件
public class ResourcesComponent : Entity, IAwake
{
    // 资源包
    private ResourcePackage package;
    
    // 加载资源
    public async ETTask<T> LoadAssetAsync<T>(string path)
        where T : Object;
    
    // 实例化资源
    public GameObject Instantiate(string path);
    
    // 释放资源
    public void UnloadAsset(string path);
}
```

### 资源加载

```csharp
// 加载Prefab
GameObject player = await resources.LoadAssetAsync<GameObject>("Assets/Prefabs/Player.prefab");
GameObject playerInstance = Object.Instantiate(player);

// 加载Sprite
Sprite icon = await resources.LoadAssetAsync<Sprite>("Assets/UI/Icons/icon.png");

// 加载场景
await resources.LoadSceneAsync("Assets/Scenes/Main.unity");
```

### 资源卸载

```csharp
// 卸载资源
resources.UnloadAsset("Assets/Prefabs/Player.prefab");

// 卸载未使用资源
await Resources.UnloadUnusedAssetsAsync();
```

## 输入系统

### 输入管理

```csharp
// 输入组件
public class InputComponent : Entity, IAwake
{
    // 鼠标位置
    public Vector3 MousePosition { get; private set; }
    
    // 按键状态
    public Dictionary<KeyCode, bool> KeyStates = new();
    
    // 获取按键状态
    public bool GetKey(KeyCode key);
    
    // 获取按键按下
    public bool GetKeyDown(KeyCode key);
    
    // 获取按键抬起
    public bool GetKeyUp(KeyCode key);
}
```

### 虚拟摇杆

```csharp
// 虚拟摇杆组件
public class JoystickComponent : Entity, IAwake
{
    // 摇杆方向
    public Vector2 Direction { get; private set; }
    
    // 摇杆距离
    public float Distance { get; private set; }
    
    // 是否按下
    public bool IsPressed { get; private set; }
}
```

### 输入示例

```csharp
// 玩家移动
[EntitySystemOf(typeof(PlayerComponent))]
public static partial class PlayerComponentSystem
{
    [EntitySystem]
    private static void Update(this PlayerComponent self)
    {
        // 获取输入
        InputComponent input = self.Root.GetComponent<InputComponent>();
        
        // 计算移动方向
        Vector3 moveDirection = Vector3.zero;
        if (input.GetKey(KeyCode.W)) moveDirection += Vector3.forward;
        if (input.GetKey(KeyCode.S)) moveDirection += Vector3.back;
        if (input.GetKey(KeyCode.A)) moveDirection += Vector3.left;
        if (input.GetKey(KeyCode.D)) moveDirection += Vector3.right;
        
        // 移动玩家
        self.GetComponent<MoveComponent>().Move(moveDirection);
    }
}
```

## 场景管理

### 场景组件

```csharp
// 场景管理组件
public class SceneComponent : Entity, IAwake
{
    // 当前场景
    public Scene CurrentScene;
    
    // 场景配置
    public Dictionary<string, SceneConfig> SceneConfigs = new();
    
    // 切换场景
    public async ETTask ChangeScene(string sceneName);
    
    // 加载场景
    public async ETTask LoadScene(string sceneName);
    
    // 卸载场景
    public async ETTask UnloadScene(string sceneName);
}
```

### 场景切换

```csharp
// 切换到地图场景
[Event(SceneType.Client)]
public class EnterMapEvent : AEvent<Scene, EventType.EnterMap>
{
    protected override async ETTask Run(Scene scene, EventType.EnterMap args)
    {
        // 1. 加载地图场景
        await scene.GetComponent<SceneComponent>().LoadScene(args.MapName);
        
        // 2. 创建玩家
        Unit player = await CreatePlayer(scene, args.PlayerId);
        
        // 3. 初始化相机
        await InitCamera(scene, player);
        
        // 4. 显示UI
        await UIManager.Instance.Open("DlgGame");
    }
}
```

## 网络通信

### 网络组件

```csharp
// 网络组件
public class NetComponent : Entity, IAwake
{
    // 网络服务
    private AService service;
    
    // 会话
    private Session session;
    
    // 连接服务器
    public async ETTask Connect(string address, int port);
    
    // 发送消息
    public void Send(IMessage message);
    
    // 调用消息
    public async ETTask<TResponse> Call<TResponse>(IRequest request)
        where TResponse : IResponse, new();
}
```

### 网络连接

```csharp
// 连接到服务器
NetComponent net = root.AddComponent<NetComponent>();
await net.Connect("127.0.0.1", 10002);

// 发送消息
C2M_Test message = C2M_Test.Create();
net.Send(message);

// 调用消息
var response = await net.Call<C2M_Login, R2C_Login>(loginRequest);
```

## 音频系统

### 音频组件

```csharp
// 音频组件
public class AudioComponent : Entity, IAwake
{
    // 音频源
    private AudioSource audioSource;
    
    // 播放音乐
    public void PlayMusic(string audioPath);
    
    // 播放音效
    public void PlaySound(string audioPath);
    
    // 停止音乐
    public void StopMusic();
}
```

### 音频播放

```csharp
// 播放背景音乐
audio.PlayMusic("Assets/Audio/MainMusic.mp3");

// 播放音效
audio.PlaySound("Assets/Audio/ClickSound.wav");

// 停止音乐
audio.StopMusic();
```

## 动画系统

### 动画组件

```csharp
// 动画组件
public class AnimationComponent : Entity, IAwake
{
    // 动画控制器
    private Animator animator;
    
    // 播放动画
    public void Play(string animationName);
    
    // 设置动画参数
    public void SetBool(string name, bool value);
    public void SetFloat(string name, float value);
    public void SetInt(string name, int value);
}
```

### 动画控制

```csharp
// 播放攻击动画
animation.Play("Attack");

// 设置移动速度
animation.SetFloat("Speed", 5.0f);

// 设置攻击状态
animation.SetBool("IsAttacking", true);
```

## 最佳实践

### 1. UI设计
- 使用EUI系统
- 分离UI和逻辑
- 使用对象池

### 2. 资源管理
- 异步加载
- 及时释放
- 使用资源包

### 3. 输入处理
- 统一输入管理
- 支持多种输入
- 输入缓冲

### 4. 性能优化
- 减少DrawCall
- 使用对象池
- 异步处理

## 常见问题

### Q: 如何优化UI性能?
A: 
1. 减少UI重绘
2. 使用对象池
3. 异步加载UI资源
4. 合理设置Canvas

### Q: 如何处理网络断线?
A: 
1. 监听网络状态
2. 实现自动重连
3. 保存本地状态
4. 显示重连提示

### Q: 如何优化内存使用?
A: 
1. 及时释放资源
2. 使用对象池
3. 优化贴图和模型
4. 定期GC

## 相关文档

- [ECS架构](ECS架构.md)
- [热更新机制](热更新机制.md)
- [网络通信模块](网络通信模块.md)
- [服务端模块](服务端模块.md)
